<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DOM ë¶ˆì¼ì¹˜ í…ŒìŠ¤íŠ¸</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .container {
        border: 1px solid #ccc;
        padding: 20px;
        margin: 10px 0;
      }
      button {
        margin: 5px;
        padding: 10px;
        cursor: pointer;
      }
      .error {
        color: red;
        background: #ffe6e6;
        padding: 10px;
        margin: 5px 0;
      }
      .warning {
        color: orange;
        background: #fff3e0;
        padding: 10px;
        margin: 5px 0;
      }
      .info {
        color: blue;
        background: #e3f2fd;
        padding: 10px;
        margin: 5px 0;
      }
    </style>
  </head>
  <body>
    <h1>oldNodeì™€ ì‹¤ì œ DOM ë¶ˆì¼ì¹˜ í…ŒìŠ¤íŠ¸</h1>

    <div class="container">
      <h3>í…ŒìŠ¤íŠ¸ ì˜ì—­</h3>
      <div id="test-container"></div>
    </div>

    <div class="container">
      <h3>í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë“¤</h3>
      <button onclick="testInitialVsUpdate()">ğŸ—ï¸ ìµœì´ˆ vs ì—…ë°ì´íŠ¸ ì°¨ì´</button>
      <button onclick="testExternalDOMManipulation()">ğŸ”§ ì™¸ë¶€ DOM ì¡°ì‘</button>
      <button onclick="testFailedUpdate()">ğŸ’¥ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ ì‹œë®¬ë ˆì´ì…˜</button>
      <button onclick="testFragmentHandling()">ğŸ“¦ Fragment ì²˜ë¦¬</button>
      <button onclick="testMultipleUpdates()">âš¡ ë¹ ë¥¸ ì—°ì† ì—…ë°ì´íŠ¸</button>
      <button onclick="reset()">ğŸ”„ ë¦¬ì…‹</button>
    </div>

    <div class="container">
      <h3>í˜„ì¬ ìƒíƒœ</h3>
      <div id="status"></div>
    </div>

    <script type="module">
      import { renderElement, createVNode } from "./src/lib/index.js";

      const container = document.getElementById("test-container");
      const statusEl = document.getElementById("status");

      function updateStatus(message, type = "info") {
        const div = document.createElement("div");
        div.className = type;
        div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
        statusEl.appendChild(div);
        statusEl.scrollTop = statusEl.scrollHeight;
      }

      function inspectDOM() {
        console.log("=== DOM ê²€ì‚¬ ===");
        console.log("container.childNodes:", container.childNodes);
        console.log("container.children:", container.children);
        console.log("container.innerHTML:", container.innerHTML);
        console.log("container._prevVNode:", container._prevVNode);
      }

      // 1. ìµœì´ˆ ë Œë”ë§ vs ì—…ë°ì´íŠ¸ì˜ ì°¨ì´
      window.testInitialVsUpdate = function () {
        console.log("\n=== ğŸ—ï¸ ìµœì´ˆ vs ì—…ë°ì´íŠ¸ ì°¨ì´ í…ŒìŠ¤íŠ¸ ===");
        updateStatus("ìµœì´ˆ ë Œë”ë§ vs ì—…ë°ì´íŠ¸ ì°¨ì´ í…ŒìŠ¤íŠ¸ ì‹œì‘");

        // ìµœì´ˆ ë Œë”ë§
        console.log("1. ìµœì´ˆ ë Œë”ë§");
        renderElement(
          createVNode(
            "div",
            { id: "root" },
            createVNode("span", null, "Child 1"),
            createVNode("span", null, "Child 2"),
          ),
          container,
        );
        inspectDOM();
        updateStatus("ìµœì´ˆ ë Œë”ë§ ì™„ë£Œ - ì½˜ì†”ì—ì„œ DOM êµ¬ì¡° í™•ì¸");

        // ì ì‹œ í›„ ì—…ë°ì´íŠ¸
        setTimeout(() => {
          console.log("2. ì—…ë°ì´íŠ¸ ë Œë”ë§");
          renderElement(
            createVNode(
              "div",
              { id: "root" },
              createVNode("span", null, "Updated Child 1"),
              createVNode("span", null, "Updated Child 2"),
              createVNode("span", null, "New Child 3"),
            ),
            container,
          );
          inspectDOM();
          updateStatus("ì—…ë°ì´íŠ¸ ë Œë”ë§ ì™„ë£Œ - oldNodeì™€ ì‹¤ì œ DOM ë¹„êµ");
        }, 1000);
      };

      // 2. ì™¸ë¶€ DOM ì¡°ì‘ìœ¼ë¡œ ì¸í•œ ë¶ˆì¼ì¹˜
      window.testExternalDOMManipulation = function () {
        console.log("\n=== ğŸ”§ ì™¸ë¶€ DOM ì¡°ì‘ í…ŒìŠ¤íŠ¸ ===");
        updateStatus("ì™¸ë¶€ DOM ì¡°ì‘ í…ŒìŠ¤íŠ¸ ì‹œì‘");

        // ì´ˆê¸° ë Œë”ë§
        renderElement(
          createVNode("div", null, createVNode("p", null, "Original"), createVNode("p", null, "Content")),
          container,
        );
        updateStatus("ì´ˆê¸° ë Œë”ë§ ì™„ë£Œ");

        setTimeout(() => {
          // ì™¸ë¶€ì—ì„œ DOM ì§ì ‘ ì¡°ì‘
          console.log("ì™¸ë¶€ì—ì„œ DOM ì§ì ‘ ì¡°ì‘");
          const firstP = container.querySelector("p");
          if (firstP) {
            firstP.remove(); // DOMì—ì„œ ì§ì ‘ ì œê±°
            updateStatus("ì²« ë²ˆì§¸ p íƒœê·¸ë¥¼ DOMì—ì„œ ì§ì ‘ ì œê±°", "warning");
          }

          setTimeout(() => {
            // Virtual DOM ì—…ë°ì´íŠ¸ (ì‹¤ì œ DOMê³¼ ë¶ˆì¼ì¹˜ ìƒíƒœì—ì„œ)
            console.log("Virtual DOM ì—…ë°ì´íŠ¸ ì‹œë„");
            renderElement(
              createVNode(
                "div",
                null,
                createVNode("p", null, "Updated Original"),
                createVNode("p", null, "Updated Content"),
              ),
              container,
            );
            updateStatus("Virtual DOM ì—…ë°ì´íŠ¸ ì™„ë£Œ - oldNodeì™€ ì‹¤ì œ DOM ë¶ˆì¼ì¹˜ ë°œìƒ", "error");
            inspectDOM();
          }, 1000);
        }, 1000);
      };

      // 3. ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ ì‹œë®¬ë ˆì´ì…˜
      window.testFailedUpdate = function () {
        console.log("\n=== ğŸ’¥ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ ì‹œë®¬ë ˆì´ì…˜ ===");
        updateStatus("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘");

        renderElement(createVNode("div", null, "Initial"), container);

        setTimeout(() => {
          // updateElement í•¨ìˆ˜ë¥¼ ì¼ì‹œì ìœ¼ë¡œ ì˜¤ë¥˜ ë°œìƒì‹œí‚¤ê¸°
          const originalUpdateElement = window.updateElement;

          // ì¼ë¶€ëŸ¬ ì—ëŸ¬ ë°œìƒ
          try {
            renderElement(createVNode("div", null, "Should Fail"), container);
          } catch (error) {
            updateStatus("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ ì‹œë®¬ë ˆì´ì…˜ - ì‹¤ì œë¡œëŠ” ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ", "warning");
          }

          setTimeout(() => {
            renderElement(createVNode("div", null, "Recovery Attempt"), container);
            updateStatus("ë³µêµ¬ ì‹œë„ ì™„ë£Œ");
            inspectDOM();
          }, 1000);
        }, 1000);
      };

      // 4. Fragment ì²˜ë¦¬ í…ŒìŠ¤íŠ¸
      window.testFragmentHandling = function () {
        console.log("\n=== ğŸ“¦ Fragment ì²˜ë¦¬ í…ŒìŠ¤íŠ¸ ===");
        updateStatus("Fragment ì²˜ë¦¬ í…ŒìŠ¤íŠ¸ ì‹œì‘");

        // ë°°ì—´ì„ ì‚¬ìš©í•œ ë Œë”ë§ (Fragment ìƒì„±)
        renderElement(
          [
            createVNode("div", null, "Fragment Child 1"),
            createVNode("div", null, "Fragment Child 2"),
            createVNode("div", null, "Fragment Child 3"),
          ],
          container,
        );

        updateStatus("Fragmentë¡œ ì´ˆê¸° ë Œë”ë§ ì™„ë£Œ");
        inspectDOM();

        setTimeout(() => {
          // ë‹¨ì¼ ìš”ì†Œë¡œ ì—…ë°ì´íŠ¸
          renderElement(createVNode("div", null, "Single Element"), container);
          updateStatus("ë‹¨ì¼ ìš”ì†Œë¡œ ì—…ë°ì´íŠ¸ ì™„ë£Œ - Fragment vs Element êµ¬ì¡° ì°¨ì´");
          inspectDOM();
        }, 2000);
      };

      // 5. ë¹ ë¥¸ ì—°ì† ì—…ë°ì´íŠ¸
      window.testMultipleUpdates = function () {
        console.log("\n=== âš¡ ë¹ ë¥¸ ì—°ì† ì—…ë°ì´íŠ¸ í…ŒìŠ¤íŠ¸ ===");
        updateStatus("ë¹ ë¥¸ ì—°ì† ì—…ë°ì´íŠ¸ í…ŒìŠ¤íŠ¸ ì‹œì‘");

        let counter = 0;
        const interval = setInterval(() => {
          counter++;
          renderElement(createVNode("div", null, `Count: ${counter}`), container);

          if (counter >= 5) {
            clearInterval(interval);
            updateStatus("ë¹ ë¥¸ ì—°ì† ì—…ë°ì´íŠ¸ ì™„ë£Œ");
            inspectDOM();
          }
        }, 100); // 100msë§ˆë‹¤ ì—…ë°ì´íŠ¸
      };

      // ë¦¬ì…‹
      window.reset = function () {
        container.innerHTML = "";
        container._prevVNode = null;
        statusEl.innerHTML = "";
        updateStatus("ë¦¬ì…‹ ì™„ë£Œ");
      };

      updateStatus("í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ");
    </script>
  </body>
</html>
